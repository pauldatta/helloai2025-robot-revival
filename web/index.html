<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aum's Journey - Mission Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --dark-bg: #1a1a1a; --panel-bg: #242424; --border-color: #3a3a3a;
            --text-color: #e0e0e0; --text-muted: #888; --accent-color: #00aaff;
        }
        body { background-color: var(--dark-bg); color: var(--text-color); font-family: 'Segoe UI', sans-serif; }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 450px 320px;
            grid-template-rows: auto 1fr;
            grid-template-areas: "header header header" "main systems widgets";
            gap: 15px; height: 100vh; padding: 15px;
        }
        .header { grid-area: header; }
        .main-content { grid-area: main; }
        .systems-column { grid-area: systems; }
        .widgets-column { grid-area: widgets; }
        
        .panel {
            background-color: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 20px; display: flex; flex-direction: column;
            overflow: hidden;
        }
        .panel-title { margin-bottom: 15px; font-weight: bold; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .scroll-content { overflow-y: auto; }
        
        #transcript-container { font-size: 1.1em; line-height: 1.7; }
        .user-speech { color: var(--accent-color); }
        .ai-narrative { color: var(--text-color); }

        #log-container { font-family: 'SF Mono', 'Courier New', monospace; font-size: 0.8em; color: var(--text-muted); }
        
        .status-item { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
        .status-value { padding: 3px 10px; border-radius: 5px; background-color: #333; font-weight: bold; }

        #map-widget {
            position: relative; width: 100%; padding-bottom: 100%; border-radius: 50%;
            background-image: url('/static/Server_Screenshot.png'); background-size: 150%;
            background-position: 52% 50%; border: 4px solid var(--border-color);
        }
        #arm-indicator {
            position: absolute; width: 20px; height: 20px; background-color: var(--accent-color);
            border-radius: 50%; border: 2px solid white; transform: translate(-50%, -50%);
            transition: top 0.5s ease, left 0.5s ease; top: 50%; left: 50%;
        }
        #qr-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none; /* Hidden by default */
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 1000;
        }
        #qr-overlay img { width: 400px; height: 400px; border: 5px solid white; border-radius: 10px; }
        #qr-overlay p { color: white; font-size: 1.5em; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="qr-overlay">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=https://example.com" alt="QR Code">
        <p>Scan to continue the journey!</p>
    </div>

    <div class="grid-container">
        <header class="header panel">
            <h4 class="m-0">Aum's Journey - Mission Control</h4>
        </header>

        <main class="main-content panel">
            <div class="panel-title">Conversation Transcript</div>
            <div id="transcript-container" class="scroll-content"></div>
        </main>

        <section class="systems-column d-flex flex-column gap-3">
            <div class="panel">
                <div class="panel-title">System Status</div>
                <div class="status-item"><span>Director:</span> <span id="status-director" class="status-value">STANDBY</span></div>
                <div class="status-item"><span>Orchestrator:</span> <span id="status-orchestrator" class="status-value">IDLE</span></div>
                <div class="status-item"><span>Current Scene:</span> <span id="status-scene" class="status-value">AWAITING</span></div>
            </div>
            <div class="panel flex-grow-1">
                <div class="panel-title">Full Log Stream</div>
                <div id="log-container" class="scroll-content"></div>
            </div>
        </section>

        <aside class="widgets-column d-flex flex-column gap-3">
            <div class="panel">
                <div class="panel-title">Diorama Map</div>
                <div id="map-widget">
                    <div id="arm-indicator"></div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-title">Scene Controls</div>
                <div id="scene-controls" class="d-grid gap-2"></div>
            </div>
            <div class="panel">
                <div class="panel-title">Manual Arm Control</div>
                <div class="input-group mb-2">
                    <span class="input-group-text">P1</span>
                    <input type="number" class="form-control" id="p1-input" value="2468" min="2400" max="4000">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">P2</span>
                    <input type="number" class="form-control" id="p2-input" value="68" min="60" max="1500">
                </div>
                <div class="input-group mb-3">
                    <span class="input-group-text">P3</span>
                    <input type="number" class="form-control" id="p3-input" value="2980" min="2000" max="4000">
                </div>
                <button id="move-arm-btn" class="btn btn-primary">Move Arm</button>
            </div>
        </aside>
    </div>

    <script>
        // DOM Elements & State
        const SCENES = ["AUMS_HOME", "PARK_AND_CITY", "ROAD_TO_HUA_HIN", "INTERNET_CAFE", "MAP_VISUAL", "ROAD_TO_BANGKOK"];
        const P1_MIN = 2400, P1_MAX = 4000;
        const P2_MIN = 60, P2_MAX = 1500;

        // Helper Functions
        function addTranscriptItem(text, speaker) {
            const transcriptContainer = document.getElementById('transcript-container');
            const item = document.createElement('div');
            item.className = speaker === 'User' ? 'user-speech' : 'ai-narrative';
            item.innerHTML = `<strong>${speaker}:</strong> ${text}`;
            transcriptContainer.appendChild(item);
            transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
        }

        function logFormattedMessage(logData) {
            const logContainer = document.getElementById('log-container');
            const logElement = document.createElement('div');

            const time = document.createElement('span');
            time.textContent = `${logData.asctime.split(',')[1].trim()} `;
            time.style.color = '#666';

            const level = document.createElement('span');
            level.textContent = `[${logData.levelname}] `;
            if (logData.levelname === 'INFO') level.style.color = '#68a0ff';
            else if (logData.levelname === 'ERROR') level.style.color = '#ff6868';
            else level.style.color = '#ffc107';

            const msg = document.createElement('span');
            msg.textContent = logData.message;
            msg.style.color = '#ddd';

            logElement.appendChild(time);
            logElement.appendChild(level);
            logElement.appendChild(msg);
            
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function mapCoordinates(p1, p2) {
            const p1_norm = (p1 - P1_MIN) / (P1_MAX - P1_MIN);
            const p2_norm = (p2 - P2_MIN) / (P2_MAX - P2_MIN);
            return {
                left: Math.max(5, Math.min(95, p1_norm * 100)),
                top: Math.max(5, Math.min(95, p2_norm * 100))
            };
        }

        function updateDashboard(message) {
            if (message.startsWith('[DIRECTOR] ---> User speech detected')) {
                addTranscriptItem(message.split(': "')[1].slice(0, -1), 'User');
                document.getElementById('status-director').innerHTML = "<strong>Director:</strong> LISTENING";
            } else if (message.startsWith('[DIRECTOR] <--- Received narrative')) {
                addTranscriptItem(message.split(': "')[1].split('" |')[0], 'Aum');
            }
            if (message.includes('Updated scene to') || message.includes('Scene state is now')) {
                const scene = message.split('"')[1];
                const sceneEl = document.getElementById('status-scene');
                sceneEl.textContent = scene.replace(/_/g, ' ');
                if (scene === 'MANUAL_OVERRIDE') {
                    sceneEl.classList.add('text-warning');
                } else {
                    sceneEl.classList.remove('text-warning');
                }
                document.getElementById('status-orchestrator').textContent = "IDLE";
            }
            if (message.includes('Calling Gemini API')) {
                document.getElementById('status-orchestrator').textContent = "THINKING";
            }
            if (message.includes("Queuing action: move_robotic_arm") || message.includes("Manually moving arm to")) {
                const p1Match = /p1=(\d+)/.exec(message) || /'p1': (\d+)/.exec(message);
                const p2Match = /p2=(\d+)/.exec(message) || /'p2': (\d+)/.exec(message);
                if (p1Match && p2Match) {
                    const p1 = parseInt(p1Match[1], 10);
                    const p2 = parseInt(p2Match[1], 10);
                    const { left, top } = mapCoordinates(p1, p2);
                    document.getElementById('arm-indicator').style.left = `${left}%`;
                    document.getElementById('arm-indicator').style.top = `${top}%`;
                }
            }
        }

        // WebSocket Connection
        function connectLogs() {
            const socket = new WebSocket(`ws://${window.location.host}/ws/logs`);
            socket.onopen = () => logFormattedMessage({ asctime: new Date().toISOString(), levelname: 'SYSTEM', message: 'Log connection established.'});
            socket.onclose = () => setTimeout(connectLogs, 2000);
            socket.onerror = (error) => console.error("Log WebSocket error:", error);
            socket.onmessage = (event) => {
                try {
                    const logData = JSON.parse(event.data);
                    logFormattedMessage(logData);
                    updateDashboard(logData.message);
                } catch (e) { /* Ignore */ }
            };
        }

        // --- Control WebSocket ---
        let controlSocket;
        function connectControl() {
            controlSocket = new WebSocket(`ws://${window.location.host}/ws/control`);
            controlSocket.onopen = () => console.log("Control WebSocket connected.");
            controlSocket.onclose = () => {
                console.log("Control WebSocket disconnected. Retrying...");
                setTimeout(connectControl, 2000);
            };
            controlSocket.onerror = (error) => console.error("Control WebSocket error:", error);
            controlSocket.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    if (message.type === 'display_qr') {
                        document.getElementById('qr-overlay').style.display = 'flex';
                    }
                } catch (e) {
                    console.error("Error parsing control message:", e);
                }
            };
        }

        function sendControlCommand(command) {
            if (controlSocket && controlSocket.readyState === WebSocket.OPEN) {
                controlSocket.send(JSON.stringify(command));
            } else {
                console.error("Control socket not open. Command not sent.");
            }
        }


        // Initial Setup
        const sceneControls = document.getElementById('scene-controls');
        
        SCENES.forEach(scene => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-secondary';
            btn.textContent = scene.replace(/_/g, ' ');
            btn.onclick = () => {
                sendControlCommand({ type: "trigger_scene", scene_name: scene });
            };
            sceneControls.appendChild(btn);
        });

        document.getElementById('move-arm-btn').onclick = () => {
            const p1 = parseInt(document.getElementById('p1-input').value, 10);
            const p2 = parseInt(document.getElementById('p2-input').value, 10);
            const p3 = parseInt(document.getElementById('p3-input').value, 10);
            sendControlCommand({ type: "move_robotic_arm", params: { p1, p2, p3 } });
        };
        
        connectLogs();
        connectControl();
    </script>
</body>
</html>