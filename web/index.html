<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aum's Journey - Mission Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --dark-bg: #121212;
            --panel-bg: #1e1e1e;
            --border-color: #333;
            --text-color: #e0e0e0;
            --director-color: #5c8aff;
            --orchestrator-color: #ff9f5c;
            --hardware-color: #5cff9f;
            --system-color: #a95cff;
            --error-color: #ff5c5c;
        }
        body {
            background-color: var(--dark-bg);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            grid-template-rows: auto 1fr;
            gap: 15px;
            height: 95vh;
            padding: 15px;
        }
        .grid-header { grid-column: 1 / -1; }
        .grid-main { grid-column: 1 / 2; display: flex; flex-direction: column; }
        .grid-sidebar { grid-column: 2 / 3; display: flex; flex-direction: column; gap: 15px; }
        
        .panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel-title {
            margin-bottom: 10px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .scroll-content {
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }
        #log-container .log-message { white-space: pre-wrap; margin-bottom: 2px; }
        #transcript-container .transcript-item { margin-bottom: 10px; }
        .user-speech { color: var(--director-color); }
        .ai-narrative { color: var(--orchestrator-color); }

        #status-panel .status-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .status-label { font-weight: bold; }
        .status-value { padding: 2px 8px; border-radius: 5px; background-color: #333; }
    </style>
</head>
<body>
    <div class="grid-container">
        <header class="grid-header panel">
            <h4 class="m-0">Aum's Journey - Mission Control</h4>
        </header>

        <main class="grid-main panel">
            <div class="panel-title">Full Log Stream</div>
            <div id="log-container" class="scroll-content"></div>
        </main>

        <aside class="grid-sidebar">
            <div id="status-panel" class="panel">
                <div class="panel-title">System Status</div>
                <div class="status-item"><span class="status-label">Director:</span> <span id="status-director" class="status-value">...</span></div>
                <div class="status-item"><span class="status-label">Orchestrator:</span> <span id="status-orchestrator" class="status-value">...</span></div>
                <div class="status-item"><span class="status-label">Current Scene:</span> <span id="status-scene" class="status-value">AWAITING</span></div>
            </div>
            <div class="panel flex-grow-1">
                <div class="panel-title">Conversation Transcript</div>
                <div id="transcript-container" class="scroll-content"></div>
            </div>
            <div class="panel">
                <div class="panel-title">Controls</div>
                <button id="stop-button" class="btn btn-danger w-100">Emergency Stop</button>
            </div>
        </aside>
    </div>

    <script>
        const logContainer = document.getElementById('log-container');
        const transcriptContainer = document.getElementById('transcript-container');
        const statusDirector = document.getElementById('status-director');
        const statusOrchestrator = document.getElementById('status-orchestrator');
        const statusScene = document.getElementById('status-scene');

        function connect() {
            const socket = new WebSocket(`ws://${window.location.host}/ws/logs`);

            socket.onopen = () => logSystemMessage('Connected to log stream.', '#28a745');
            socket.onclose = () => {
                logSystemMessage('Disconnected. Retrying...', '#ffc107');
                setTimeout(connect, 2000);
            };
            socket.onerror = (error) => {
                console.error("WebSocket error:", error);
                logSystemMessage('Connection error.', '#ff5c5c');
            };
            socket.onmessage = (event) => {
                try {
                    const logData = JSON.parse(event.data);
                    const message = logData.message;
                    
                    // Full log stream
                    const logElement = document.createElement('div');
                    logElement.className = 'log-message';
                    logElement.textContent = `${logData.asctime} - ${message}`;
                    logContainer.appendChild(logElement);
                    logContainer.scrollTop = logContainer.scrollHeight;

                    // Update status and transcript panels
                    updateDashboard(message);

                } catch (e) {
                    // Handle non-JSON system messages
                    logSystemMessage(event.data, 'grey');
                }
            };
        }

        function updateDashboard(message) {
            if (message.includes('[DIRECTOR]')) {
                if (message.includes('User speech detected')) {
                    addTranscriptItem(message.split(': "')[1].slice(0, -1), 'user-speech');
                    statusDirector.textContent = "Listening...";
                } else if (message.includes('Received narrative')) {
                    addTranscriptItem(message.split(': "')[1].split('" |')[0], 'ai-narrative');
                }
            } else if (message.includes('[ORCHESTRATOR]')) {
                if (message.includes('Updated scene to')) {
                    const scene = message.split('"')[1];
                    statusScene.textContent = scene;
                    statusOrchestrator.textContent = "Idle";
                } else if (message.includes('Calling Gemini API')) {
                    statusOrchestrator.textContent = "Thinking...";
                }
            }
        }

        function addTranscriptItem(text, className) {
            const item = document.createElement('div');
            item.className = `transcript-item ${className}`;
            const label = document.createElement('strong');
            label.textContent = className === 'user-speech' ? 'User: ' : 'Aum: ';
            item.appendChild(label);
            item.append(text);
            transcriptContainer.appendChild(item);
            transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
        }

        function logSystemMessage(message, color) {
            const logElement = document.createElement('div');
            logElement.className = 'log-message';
            logElement.style.color = color;
            logElement.textContent = message;
            logContainer.appendChild(logElement);
        }

        document.getElementById('stop-button').onclick = () => alert('Emergency Stop clicked!');
        
        connect();
    </script>
</body>
</html>